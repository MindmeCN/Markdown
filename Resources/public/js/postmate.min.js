!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.Postmate=n()}(this,function(){"use strict";function e(){var e;(e=console).log.apply(e,arguments)}function n(e){var n=document.createElement("a");return n.href=e,n.origin}function t(e,n){return e.origin===n&&("object"===r(e.data)&&("postmate"in e.data&&e.data.type===d))}function a(e,n,t){var a="function"==typeof e[n]?e[n](t):e[n];return Promise.resolve(a)}function i(n){var i=n.id,r=n.context,o=n.parent,s=n.parentOrigin,u=n.frame,c=n.child,h=n.childOrigin;return e('Registering consumer: "'+i+'"'),"parent"===i?(e("Parent awaiting messages..."),{frame:u,get:function(e,n){return new Promise(function(t){var a=(new Date).getTime(),i=function e(n){n.data.uid===a&&(o.removeEventListener("message",e,!1),t(n.data.value))};o.addEventListener("message",i,!1),c.postMessage({data:n,postmate:"request",type:d,key:e,uid:a},h)})}}):void("child"===i&&(e("Child awaiting messages..."),c.addEventListener("message",function(n){if(t(n,s)){e("Child received message",n.data);var i=n.data,o=i.data,u=i.key,c=i.uid;a(r,u,o).then(function(e){return n.source.postMessage({key:u,postmate:"reply",type:d,uid:c,value:e},n.origin)})}})))}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},s=function(){function e(e,n){for(var t=0;t<n.length;t++){var a=n[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(n,t,a){return t&&e(n.prototype,t),a&&e(n,a),n}}(),d="application/x-postmate-v1+json",u=function(){function n(e){return o(this,n),this.id="child",this.child=window,this.context=e,this.parent=this.child.parent,this.sendHandshakeReply()}return s(n,[{key:"sendHandshakeReply",value:function(){var n=this;return new Promise(function(t,a){var r=function r(o){return"handshake"===o.data.postmate?(e("Child: Received handshake from Parent"),n.child.removeEventListener("message",r,!1),e("Child: Sending handshake reply to Parent"),o.source.postMessage({postmate:"handshake-reply",type:d},o.origin),n.parentOrigin=o.origin,e("Child: Saving Parent origin",n.parentOrigin),t(new i(n))):a("Handshake Reply Failed")};n.child.addEventListener("message",r,!1)})}}]),n}();return u.Handshake=function(){function a(e){o(this,a);var n=e.container,t=e.url;return this.id="parent",this.parent=window,this.frame=document.createElement("iframe"),n.appendChild(this.frame),this.child=this.frame.contentWindow,this.sendHandshake(t)}return s(a,[{key:"sendHandshake",value:function(a){var r=this,o=n(a);return new Promise(function(n,s){var u=function a(d){return t(d,o)?"handshake-reply"===d.data.postmate?(e("Parent: Received handshake reply from Child"),r.parent.removeEventListener("message",a,!1),r.childOrigin=d.origin,e("Parent: Saving Child origin",r.childOrigin),n(new i(r))):(e("Parent: Invalid handshake reply"),s("Failed handshake")):s("Invalid message signature")};r.parent.addEventListener("message",u,!1),r.frame.onload=function(){e("Parent: Sending handshake"),r.child.postMessage({postmate:"handshake",type:d},o)},e("Parent: Loading frame"),r.frame.src=a})}}]),a}(),u});